<div class="container mx-auto p-6 bg-white shadow-lg rounded-lg">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">{{ isEditMode ? 'Modifier le Dossier' : 'Nouveau Dossier' }}</h2>

  <form [formGroup]="dossierForm" (ngSubmit)="onSubmit()">

    <!-- Informations Générales -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Référence Interne</label>
        <input type="text" formControlName="referenceInterne"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Titre</label>
        <input type="text" formControlName="titre"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
    </div>




    <!-- Tags -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700">Tags</label>
      <div class="flex items-center mt-1 mb-2">
        <input type="text" (keydown.enter)="$event.preventDefault(); addTag($event)"
          placeholder="Ajouter un tag et appuyer sur Entrée"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
      <div class="flex flex-wrap gap-2">
        @for (tag of tags; track tag; let i = $index) {
        <span class="inline-flex items-center bg-gray-100 text-gray-800 rounded-full px-3 py-1 text-sm font-medium">
          {{ tag }}
          <button type="button" (click)="removeTag(i)"
            class="ml-2 text-gray-500 hover:text-gray-700 focus:outline-none">
            <span class="sr-only">Retirer</span>
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd" />
            </svg>
          </button>
        </span>
        }
      </div>
    </div>

    <!-- Relations -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>

        <div *ngIf="getSelectedClientName()"
          class="flex items-center justify-between p-2 border rounded-md bg-gray-50 mb-2">
          <div>
            <p class="text-sm font-medium text-gray-900">{{ getSelectedClientName() }}</p>
            <p class="text-xs text-gray-500">Client #{{ dossierForm.get('clientId')?.value }}</p>
          </div>
          <button type="button" (click)="openClientDialog()"
            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
            Changer
          </button>
        </div>

        <button *ngIf="!getSelectedClientName()" type="button" (click)="openClientDialog()"
          class="input-trigger w-full flex items-center justify-between p-2 border border-gray-300 rounded-md text-gray-500 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span>Sélectionner un client</span>
          <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <app-client-selection-dialog *ngIf="showClientDialog" [clients]="clients"
          [initialSelection]="dossierForm.get('clientId')?.value" (confirmSelection)="onClientSelected($event)"
          (closeDialog)="closeClientDialog()">
        </app-client-selection-dialog>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Responsable</label>

        <div *ngIf="getSelectedResponsableName()"
          class="flex items-center justify-between p-2 border rounded-md bg-gray-50 mb-2">
          <div>
            <p class="text-sm font-medium text-gray-900">{{ getSelectedResponsableName() }}</p>
          </div>
          <button type="button" (click)="openResponsableDialog()"
            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
            Changer
          </button>
        </div>

        <button *ngIf="!getSelectedResponsableName()" type="button" (click)="openResponsableDialog()"
          class="input-trigger w-full flex items-center justify-between p-2 border border-gray-300 rounded-md text-gray-500 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span>Sélectionner un responsable</span>
          <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <app-user-selection-dialog *ngIf="showResponsableDialog" [users]="users"
          [initialSelection]="dossierForm.get('responsableId')?.value ? [dossierForm.get('responsableId')?.value] : []"
          [singleSelection]="true" (confirmSelection)="onResponsableSelected($event)"
          (closeDialog)="closeResponsableDialog()">
        </app-user-selection-dialog>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Intervenants</label>

        <div class="flex flex-wrap gap-2 mb-2">
          <div *ngFor="let user of getSelectedIntervenants()"
            class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm font-medium">
            {{ user.name }}
            <button type="button" (click)="removeIntervenant(user.id)"
              class="ml-2 text-blue-600 hover:text-blue-800 focus:outline-none">
              <span class="sr-only">Retirer</span>
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>

        <button type="button" (click)="openUserDialog()"
          class="inline-flex items-center px-4 py-2 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Gérer les intervenants
        </button>
      </div>

      <app-user-selection-dialog *ngIf="showUserDialog" [users]="users"
        [initialSelection]="dossierForm.get('intervenantsIds')?.value || []"
        (confirmSelection)="onUsersSelected($event)" (closeDialog)="closeUserDialog()">
      </app-user-selection-dialog>
    </div>

    <!-- Classification -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Domaine Juridique</label>
        <div class="flex items-center">
          <div *ngIf="dossierForm.get('domaineJuridique')?.value"
            class="flex-1 flex items-center p-2 bg-gray-50 border rounded-l-md border-r-0 border-gray-300">
            <div [style.background-color]="getSelectedDomaineColor()" class="w-3 h-3 rounded-full mr-2"></div>
            <span class="text-gray-900 font-medium">{{ getSelectedDomaineLabel() }}</span>
          </div>
          <button type="button" (click)="openDomaineDialog()"
            [class.rounded-l-md]="!dossierForm.get('domaineJuridique')?.value"
            class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-r-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            [ngClass]="{'w-full': !dossierForm.get('domaineJuridique')?.value}">
            <svg *ngIf="!dossierForm.get('domaineJuridique')?.value" class="-ml-1 mr-2 h-5 w-5 text-gray-400"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
            </svg>
            {{ dossierForm.get('domaineJuridique')?.value ? 'Changer' : 'Sélectionner un domaine' }}
          </button>
        </div>
        <input type="hidden" formControlName="domaineJuridique">

        <app-domaine-juridique-selection-dialog *ngIf="showDomaineDialog" [domaines]="domaines"
          [initialSelection]="dossierForm.get('domaineJuridique')?.value" (confirmSelection)="onDomaineSelected($event)"
          (closeDialog)="closeDomaineDialog()">
        </app-domaine-juridique-selection-dialog>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Priorité</label>
        <select formControlName="prioriteID"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
          <option value="">Sélectionner une priorité</option>
          <option *ngFor="let priority of priorities" [value]="priority.id">{{ priority.label }}</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Statut</label>
        <select formControlName="statutID"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
          <option value="">Sélectionner un statut</option>
          <option *ngFor="let status of statuses" [value]="status.id">{{ status.label }}</option>
        </select>
      </div>
    </div>

    <!-- Dates -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Date d'Ouverture</label>
        <input type="date" formControlName="dateOuverture"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
    </div>

    <!-- Facturation -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Méthode de Facturation</label>
        <select formControlName="methodeFacturation"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
          <option value="HORAIRE">Horaire</option>
          <option value="FORFAIT">Forfait</option>
          <option value="RESULTAT">Résultat</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Budget Estimé (€)</label>
        <input type="number" formControlName="budgetEstime"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Taux Horaire (€/h)</label>
        <input type="number" formControlName="tauxHoraireApplique"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
      </div>
    </div>

    <!-- Documents -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">Documents</label>

      <button type="button" (click)="openDocumentDialog()"
        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Ajouter un document
      </button>

      <app-document-dialog *ngIf="showDocumentDialog" [dialogTitle]="'Ajouter un document'"
        (addDocumentEvent)="onDocumentAdded($event)" (closeDialogEvent)="closeDocumentDialog()">
      </app-document-dialog>

      @if (documents.length > 0) {
      <div class="mt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Fichiers sélectionnés</h4>
        <ul class="divide-y divide-gray-200 border border-gray-200 rounded-md">
          @for (doc of documents; track doc.name; let i = $index) {
          <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
            <div class="w-0 flex-1 flex items-center">
              <svg class="flex-shrink-0 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd"
                  d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z"
                  clip-rule="evenodd" />
              </svg>
              <div class="ml-2 flex-1 w-0 truncate">
                <div class="flex items-center">
                  <span class="font-medium text-gray-900 truncate">{{ doc.title }}</span>
                  <span *ngIf="doc.name" class="ml-2 text-xs text-gray-500 truncate">({{ doc.name }})</span>
                </div>
                <p *ngIf="doc.description" class="text-xs text-gray-500 truncate">{{ doc.description }}</p>
              </div>
            </div>
            <div class="ml-4 flex-shrink-0">
              <button type="button" (click)="removeDocument(i)" class="font-medium text-red-600 hover:text-red-500">
                Retirer
              </button>
            </div>
          </li>
          }
        </ul>
      </div>
      }
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-4 mt-6">
      <button type="button" (click)="navigateToDossier()"
        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
        Annuler
      </button>
      <button type="submit" [disabled]="dossierForm.invalid"
        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
        {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
      </button>
    </div>
  </form>
</div>