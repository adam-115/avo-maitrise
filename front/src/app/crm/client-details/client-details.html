<div class="p-6 sm:p-10 bg-gray-50 min-h-screen" *ngIf="client">

    <div class="mb-8 border-b border-gray-200 pb-4 flex justify-between items-end">
        <div>
            <nav class="text-sm font-medium text-gray-500 mb-2">
                <a routerLink="/contacts" class="hover:text-cyan-600">Gestion des Contacts</a> /
                <span class="text-slate-800 font-semibold">{{ client.name }}</span>
            </nav>
            <h1 class="text-3xl font-bold text-slate-800 flex items-center">
                {{ client.name }} <span *ngIf="client.type === 'PERSONNE'">, {{ client.firstName }}</span>
                <span class="ml-4 px-3 py-1 text-sm font-semibold rounded-full" [ngClass]="{
                      'bg-purple-100 text-purple-800': client.type === 'SOCIETE',
                      'bg-blue-100 text-blue-800': client.type === 'PERSONNE',
                      'bg-gray-100 text-gray-800': client.type === 'INSTITUTION'
                    }">
                    {{ client.type }}
                </span>
            </h1>
            <p class="text-gray-600 mt-1">
                Rôle Principal : <span class="font-semibold text-slate-800">{{ client.role }}</span>
            </p>
        </div>

        <div class="flex space-x-3">
            <button (click)="startComplianceReview()"
                class="px-5 py-2.5 rounded-lg text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200 transition duration-150 border border-red-300">
                Lancer une Nouvelle Revue AML
            </button>
            <button (click)="editClient()"
                class="px-5 py-2.5 rounded-lg text-sm font-medium text-white bg-cyan-600 shadow-md hover:bg-cyan-700 transition duration-150">
                Éditer la Fiche
            </button>
        </div>
    </div>

    <div class="p-4 rounded-xl border-l-4 mb-8" [ngClass]="{
           'bg-red-50 border-red-600': client.amlRisk === 'ELEVEE',
           'bg-yellow-50 border-yellow-600': client.amlRisk === 'MOYEN',
           'bg-green-50 border-green-600': client.amlRisk === 'FAIBLE' || client.amlRisk === 'NUL'
         }">
        <div class="flex items-center space-x-3">
            <svg *ngIf="client.amlRisk === 'ELEVEE'" class="w-6 h-6 text-red-600" fill="currentColor"
                viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clip-rule="evenodd"></path>
            </svg>
            <svg *ngIf="client.amlRisk === 'MOYEN'" class="w-6 h-6 text-yellow-600" fill="currentColor"
                viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M8.257 3.345A4.004 4.004 0 0111.743 3.345c1.458 1.458 1.458 3.824 0 5.282l-3.232 3.232a4.004 4.004 0 01-5.282-5.282c1.458-1.458 3.824-1.458 5.282 0l3.232 3.232a2.002 2.002 0 002.83 0l-1.414-1.414a.5.5 0 00-.707 0L9.423 7.618a.5.5 0 010 .707L8.71 9.043a2.002 2.002 0 00-2.83 0l-3.232-3.232a2.002 2.002 0 012.83-2.83l3.232 3.232a.5.5 0 00.707 0l1.414-1.414a4.004 4.004 0 010-5.657z"
                    clip-rule="evenodd"></path>
            </svg>
            <svg *ngIf="client.amlRisk === 'FAIBLE' || client.amlRisk === 'NUL'" class="w-6 h-6 text-green-600"
                fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"></path>
            </svg>

            <h3 class="text-xl font-bold">Risque AML Global :
                <span [ngClass]="{
                    'text-red-700': client.amlRisk === 'ELEVEE',
                    'text-yellow-700': client.amlRisk === 'MOYEN',
                    'text-green-700': client.amlRisk === 'FAIBLE' || client.amlRisk === 'NUL'
                }">
                    {{ client.amlRisk }}
                </span>
            </h3>
        </div>
        <p class="mt-2 text-sm" [ngClass]="{
             'text-red-700': client.amlRisk === 'ELEVEE',
             'text-yellow-700': client.amlRisk === 'MOYEN',
             'text-green-700': client.amlRisk === 'FAIBLE' || client.amlRisk === 'NUL'
           }">
            Statut de Conformité KYC : **{{ client.complianceStatus }}** (Dernière validation : {{ client.validationDate
            | date: 'dd/MM/yyyy' }})
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-1 space-y-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4 text-cyan-700">1. Coordonnées &
                    Identification</h2>

                <div *ngIf="client.type === 'PERSONNE'" class="space-y-3 text-sm">
                    <p><strong>Nom Complet :</strong> {{ client.name }} {{ client.firstName }}</p>
                    <p><strong>Pays :</strong> {{ client.country }}</p>
                    <p *ngIf="client.sector"><strong>Secteur :</strong> {{ client.sector }}</p>
                </div>

                <div *ngIf="client.type === 'SOCIETE'" class="space-y-3 text-sm">
                    <p><strong>Dénomination :</strong> {{ client.name }}</p>
                    <p><strong>Forme Juridique :</strong> {{ client.legalForm }}</p>
                    <p><strong>N° SIREN/Identifiant :</strong> {{ client.siren }}</p>
                    <p><strong>Pays d'Enregistrement :</strong> {{ client.country }}</p>
                </div>

                <div *ngIf="client.type === 'INSTITUTION'" class="space-y-3 text-sm">
                    <p><strong>Nom de l'Institution :</strong> {{ client.name }}</p>
                    <p><strong>Catégorie :</strong> {{ client.role }}</p>
                    <p><strong>Localisation :</strong> {{ client.country }}</p>
                </div>

                <div class="mt-4 border-t pt-4 space-y-3 text-sm">
                    <p><strong>Email :</strong> <a href="mailto:{{ client.email }}"
                            class="text-blue-600 hover:underline">{{ client.email }}</a></p>
                    <p><strong>Téléphone :</strong> {{ client.phone }}</p>
                    <p><strong>Adresse :</strong> {{ client.address }}</p>
                </div>
            </div>

            <!-- CONTACTS SECTION -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4 text-blue-700">Points de Contact</h2>

                <div *ngIf="client.contacts && client.contacts.length > 0; else noContacts">
                    <ul class="space-y-4">
                        <li *ngFor="let contact of client.contacts"
                            class="flex items-start space-x-3 p-3 bg-slate-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <span
                                    class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-700 font-bold">
                                    {{ contact.nom?.charAt(0) || 'C' }}
                                </span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-slate-900 truncate">{{ contact.nom }}</p>
                                <p class="text-xs text-slate-500 truncate">{{ contact.fonction }}</p>
                                <div class="mt-1 flex flex-col space-y-1">
                                    <a *ngIf="contact.email" href="mailto:{{ contact.email }}"
                                        class="text-xs text-blue-600 hover:underline truncate">{{ contact.email }}</a>
                                    <a *ngIf="contact.tel" href="tel:{{ contact.tel }}"
                                        class="text-xs text-slate-600 truncate">{{ contact.tel }}</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <ng-template #noContacts>
                    <p class="text-sm text-gray-500 italic text-center py-4">Aucun contact associé.</p>
                </ng-template>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <h2 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4 text-red-700">3. Analyse Détaillée
                    AML/KYC</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-6">
                    <div class="p-4 rounded-lg border">
                        <p class="text-xs text-gray-500 font-medium uppercase">Origine des Fonds</p>
                        <p class="mt-1 font-bold text-lg text-slate-800">{{ client.fundsOrigin || 'Non renseigné' }}</p>
                    </div>

                    <div class="p-4 rounded-lg border"
                        [ngClass]="client.isPEP ? 'bg-red-50 border-red-400' : 'bg-green-50 border-green-400'">
                        <p class="text-xs text-gray-500 font-medium uppercase">Personne Politiquement Exposée (PPE)</p>
                        <p class="mt-1 font-bold text-lg" [ngClass]="client.isPEP ? 'text-red-700' : 'text-green-700'">
                            {{ client.isPEP ? 'OUI / LIÉ' : 'NON' }}
                        </p>
                    </div>

                    <div *ngIf="client.type === 'SOCIETE'" class="p-4 rounded-lg border">
                        <p class="text-xs text-gray-500 font-medium uppercase">Bénéficiaires Effectifs</p>
                        <p class="mt-1 text-sm font-bold text-slate-800 line-clamp-2">{{ client.beneficialOwners || 'Non
                            renseigné' }}</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-slate-800 mt-4 mb-2">Notes de Conformité</h3>
                    <div
                        class="bg-gray-100 p-4 rounded-lg border border-gray-200 text-sm italic text-gray-700 whitespace-pre-line">
                        {{ client.complianceNotes || 'Aucune note de diligence spécifique enregistrée.' }}
                    </div>
                </div>
            </div>

            <!-- DOCUMENTS SECTION -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4 text-green-700">2. Documents &
                    Justificatifs</h2>

                <div *ngIf="documents.length > 0; else noDocs">
                    <ul class="divide-y divide-gray-100">
                        <li *ngFor="let doc of documents"
                            class="py-3 flex justify-between items-center hover:bg-slate-50 px-2 rounded">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 h-10 w-10 text-slate-400">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-900">{{ doc.label }}</p>
                                    <p class="text-xs text-slate-500 truncate max-w-xs" title="{{ doc.filename }}">{{
                                        doc.filename }}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-xs text-gray-400">{{ doc.date | date:'shortDate' }}</span>
                                <a href="#"
                                    class="text-cyan-600 hover:text-cyan-900 text-sm font-medium">Télécharger</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <ng-template #noDocs>
                    <div class="text-center py-6 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                        <p class="text-gray-500 text-sm">Aucun document chargé pour ce dossier.</p>
                    </div>
                </ng-template>
            </div>

            <!-- AML RESULTS HISTORY -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-slate-800 border-b pb-2 mb-4 text-blue-700">4. Résultats Formulaires
                    AML</h2>

                <div *ngIf="amlResults.length > 0; else noResults">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ID Config</th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Score</th>
                                    <th
                                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Risque</th>
                                    <th
                                        class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr *ngFor="let result of amlResults">
                                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">{{
                                        result.amlFormConfigID }}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-sm font-bold text-slate-700">{{
                                        result.totalScore }} / 100</td>
                                    <td class="px-3 py-3 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                            [ngClass]="{
                                            'bg-red-100 text-red-800': result.riskLevel === 'Élevé',
                                            'bg-yellow-100 text-yellow-800': result.riskLevel === 'Modéré',
                                            'bg-green-100 text-green-800': result.riskLevel === 'Faible'
                                        }">
                                            {{ result.riskLevel }}
                                        </span>
                                    </td>
                                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                                        <a href="#" class="text-cyan-600 hover:text-cyan-900">Détails</a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <ng-template #noResults>
                    <p class="text-sm text-gray-500 italic text-center py-4">Aucun résultat de formulaire AML
                        disponible.</p>
                </ng-template>
            </div>
        </div>

    </div>

</div>